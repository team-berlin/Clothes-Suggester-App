name: Enforce Branch Naming Convention

on:
  create:
    branches:
      - '**'

jobs:
  validate-branch-name:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install yq
        run: |
          sudo apt-get update && sudo apt-get install -y jq
      - name: Read allowed prefixes
        id: load_prefixes
        run: |
          PREFIXES=$(yq e '.allowed_prefixes | join("|")' .github/branch-prefixes.yml)
          echo "ALLOWED_PREFIXES=$PREFIXES" >> $GITHUB_ENV
      - name: Check branch naming convention
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          if [[ ! "$BRANCH_NAME" =~ ^($ALLOWED_PREFIXES).+ ]]; then
            echo "❌ Branch name '$BRANCH_NAME' does not follow the required naming convention."
            exit 1
          fi
          
          if [[ "$BRANCH_NAME" =~ [A-Z] ]]; then
          echo "❌ Branch name '$BRANCH_NAME' contains uppercase letters, which are not allowed."
          exit 1
          fi
          
          if [[ "$BRANCH_NAME" =~ [^a-z0-9/-] ]]; then
          echo "❌ Branch name '$BRANCH_NAME' contains invalid characters. Only lowercase, numbers, `/`, and `-` are allowed."
          exit 1
          fi
          
          echo "✅ Branch name '$BRANCH_NAME' is valid."
          
